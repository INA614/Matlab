%% Detyra 2.1 - Llogaritja e masës invariante (GeV)

% Leximi dataset-it
data = readmatrix('dataset_Ina.csv');

% Nxirren komponentët e impulsit dhe masat
px1 = data(:,1); py1 = data(:,2); pz1 = data(:,3);
px2 = data(:,4); py2 = data(:,5); pz2 = data(:,6);
m1  = data(:,7); m2  = data(:,8);

% Konvertohen nga MeV në GeV 
px1 = px1 / 1000; py1 = py1 / 1000; pz1 = pz1 / 1000;
px2 = px2 / 1000; py2 = py2 / 1000; pz2 = pz2 / 1000;
m1  = m1 / 1000;  m2  = m2 / 1000;

% Llogaritet magnituda e impulsit
p1 = sqrt(px1.^2 + py1.^2 + pz1.^2);
p2 = sqrt(px2.^2 + py2.^2 + pz2.^2);

% Energjitë relativiste
E1 = sqrt(p1.^2 + m1.^2);
E2 = sqrt(p2.^2 + m2.^2);

% Shuma e impulseve vektoriale
px_tot = px1 + px2;
py_tot = py1 + py2;
pz_tot = pz1 + pz2;
p_tot = sqrt(px_tot.^2 + py_tot.^2 + pz_tot.^2);

% Masa invariante per çdo event
M = sqrt((E1 + E2).^2 - p_tot.^2);

% -----------------------------
% 10 invariant masses e para
M_10 = M(1:10);
disp('10 invariant mass te pare (GeV):');
disp(M_10)

% 5. Histogram i masave invariante
figure;
nbins = 50;
histogram(M, nbins);
xlabel('M (GeV)');
ylabel('Numri i ngjarjeve për bin');
title('Histogrami i masës invariante');

% 6. Gaussian fit 
% Vendoset range sipas histogramit (ndrysho në varësi të dataset-it)
Mmin = min(M);
Mmax = max(M);

idx = M >= Mmin & M <= Mmax;
M_fit = M(idx);

edges = linspace(Mmin, Mmax, nbins);
counts = histcounts(M_fit, edges);
x_centers = (edges(1:end-1)+edges(2:end))/2;

% Funksioni Gaussian: [Amplitude, Mean, StdDev, Background]
gauss_fun = @(p,x) p(1)*exp(-(x-p(2)).^2/(2*p(3)^2)) + p(4);
p0 = [max(counts), mean(M_fit), std(M_fit), min(counts)];

options = optimset('Display','off');
p_fit = lsqcurvefit(gauss_fun, p0, x_centers, counts, [], [], options);

% Nxirren parametrat
M0_fit = p_fit(2);
sigma_fit = p_fit(3);
Gamma = 2.35*sigma_fit; % përmasë aproximative e gjërë

% Shfaqet rezultatet
fprintf('Gaussian fit results:\n');
fprintf('Masa qendrore M0 = %.4f GeV\n', M0_fit);
fprintf('Sigma = %.4f GeV\n', sigma_fit);
fprintf('Approx. Gamma = %.4f GeV\n', Gamma);

% Shtohet kurba Gaussiane mbi histogram
hold on;
x_plot = linspace(Mmin, Mmax, 200);
plot(x_plot, gauss_fun(p_fit,x_plot),'r','LineWidth',2);
legend('Histogram','Gaussian fit');
